name: Configure API Gateway
on:
  workflow_dispatch:

jobs:
  configure:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: checkout
        uses: actions/checkout@v3
        
      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@master
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions
      
      - name: get caller identity is allowed to run on role.
        run: aws sts get-caller-identity

      - name: setup python
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 'stable'

      - name: configure python
        run: pip3 install awscli

      - name: delete exists gateway
        if: env.API_GATEWAY_ID != ''
        env:
          API_GATEWAY_ID: ${{ secrets.API_GATEWAY_ID }}
        run: aws apigatewayv2 --api-id ${{ env.API_GATEWAY_ID }}

      - name: create new gateway
        id: import_gateway
        run: aws apigatewayv2 import-api --body file://api_gateway/api.json
      
      - name: Store API_GATEWAY_ID on secrets2
        run: echo $API_GATEWAY_ID
        env:
          API_GATEWAY_ID: ${{ toJSON(steps.import_gateway.outputs).ApiId }}
      
      - name: Store API_GATEWAY_ID on secrets
        run: |
          sed "s/%URL%/${{ secrets.URL }}" ./api_gateway/api.json > ./api_gateway/api.json
          sed "s/%AUTHORIZER_URI%/${{ secrets.AUTHORIZER_URI }}/" ./api_gateway/api.json > ./api_gateway/api.json

          GO111MODULE=on go get -u github.com/doodlesbykumbi/github-secrets-writer
          github-secrets-writer --owner=${{ github.repository_owner }} --repo=${{ github.repository }} --from-literal=secretName1=secretValue1         
        env:
          API_GATEWAY_ID: ${{ toJSON(steps.import_gateway.outputs).ApiId }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      